# ğŸš€ Ansible ç¬”è®°ï¼šæ„å»ºè‡ªåŠ¨åŒ–è¿ç»´é›†ç¾¤ï¼ˆNginx + HAProxy + Rolesï¼‰


## 1. å®éªŒç¯å¢ƒè§„åˆ’

æˆ‘ä½¿ç”¨äº† 3 å°è™šæ‹Ÿæœºï¼Œæ“ä½œç³»ç»Ÿæ¶µç›–äº† RHEL ç³»å’Œ Debian ç³»ï¼Œä»¥æµ‹è¯• Ansible å¯¹å¼‚æ„ç³»ç»Ÿçš„å…¼å®¹æ€§ã€‚

### 1. å®éªŒç¯å¢ƒè§„åˆ’

æˆ‘ä½¿ç”¨äº† 3 å°è™šæ‹Ÿæœºï¼Œæ“ä½œç³»ç»Ÿæ¶µç›–äº† RHEL ç³»å’Œ Debian ç³»ï¼Œä»¥æµ‹è¯• Ansible å¯¹å¼‚æ„ç³»ç»Ÿçš„å…¼å®¹æ€§ã€‚

| ä¸»æœºå          | IP åœ°å€    | è§’è‰²                                        | æ“ä½œç³»ç»Ÿ       | å¤‡æ³¨                     |
|-----------------|------------|---------------------------------------------|----------------|--------------------------|
| **Rocky-12**    | 10.0.0.12 | **æ§åˆ¶èŠ‚ç‚¹ (Ansible Server)**<br>**è´Ÿè½½å‡è¡¡å™¨ (HAProxy)** | Rocky Linux 9  | **æŒ‡æŒ¥å®˜**ï¼Œæ‰€æœ‰å‘½ä»¤åœ¨æ­¤æ‰§è¡Œ |
| **Ubuntu-13**   | 10.0.0.13 | è¢«æ§èŠ‚ç‚¹ (Web Server)                       | Ubuntu 24.04   | è¿è¡Œ Nginx               |
| **Ubuntu-16**   | 10.0.0.16 | è¢«æ§èŠ‚ç‚¹ (Web Server)                       | Ubuntu 24.04   | è¿è¡Œ Nginx               |

---

## 2. åŸºç¡€ç¯å¢ƒé…ç½® (The Foundation)

### 2.1 å®‰è£… Ansible
Ansible æ˜¯æ— ä»£ç†ï¼ˆAgentlessï¼‰çš„ï¼Œåªéœ€è¦åœ¨æ§åˆ¶èŠ‚ç‚¹å®‰è£…å³å¯ã€‚

```bash
# åœ¨ Rocky 9 æ§åˆ¶èŠ‚ç‚¹ä¸Š
sudo dnf install epel-release -y
sudo dnf install ansible -y
```

### 2.2 SSH å…å¯†äº’ä¿¡ (è¸©å‘è®°å½•)
è¿™æ˜¯ Ansible é€šä¿¡çš„åŸºç¡€ã€‚
*   **è¸©å‘ï¼š** ä¸€å¼€å§‹ä½¿ç”¨äº† `ssh-keygen -p` å¯¼è‡´æŠ¥é”™ï¼Œåæ¥å‘ç°å°å†™ `-p` æ˜¯ä¿®æ”¹å¯†ç ï¼Œå¤§å†™ `-P` æ‰æ˜¯è®¾ç½®æ–°å¯†ç ï¼ˆç©ºå¯†ç ï¼‰ã€‚

**æ­£ç¡®æ“ä½œï¼š**
```bash
# 1. ç”Ÿæˆå¯†é’¥ (ä¸€è·¯å›è½¦)
ssh-keygen -t rsa -P '' -f ~/.ssh/id_rsa

# 2. åˆ†å‘å…¬é’¥åˆ°æ‰€æœ‰èŠ‚ç‚¹ (åŒ…æ‹¬è‡ªå·±)
ssh-copy-id root@10.0.0.12
ssh-copy-id root@10.0.0.13
ssh-copy-id root@10.0.0.16
```

### 2.3 æ„å»º Inventory (èŠ±åå†Œ)
ä¸ºäº†ä¸æ±¡æŸ“ç³»ç»Ÿé…ç½®ï¼Œæˆ‘åœ¨é¡¹ç›®ç›®å½•å»ºç«‹äº†ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ã€‚

**æ–‡ä»¶ç»“æ„ï¼š** `/root/ansible_start/`
*   **`hosts` (æ¸…å•æ–‡ä»¶):**
    ```ini
    [web]
    10.0.0.13
    10.0.0.16
    
    [lb]
    10.0.0.12
    ```
*   **`ansible.cfg` (é…ç½®æ–‡ä»¶):**
    ```ini
    [defaults]
    inventory = ./hosts
    host_key_checking = False  # å…³é”®é…ç½®ï¼šè·³è¿‡ SSH æŒ‡çº¹éªŒè¯
    ```

---

## 3. Ad-Hoc å‘½ä»¤ä½“éªŒ

åœ¨å†™å‰§æœ¬å‰ï¼Œå…ˆç”¨å•è¡Œå‘½ä»¤æµ‹è¯•è¿æ¥ã€‚

*   **è¿é€šæ€§æµ‹è¯•ï¼š**
    ```bash
    ansible all -m ping
    ```
*   **è·¨å¹³å°å®‰è£…è½¯ä»¶ (æ··åˆåŒæ‰“)ï¼š**
    ä½¿ç”¨ `package` æ¨¡å—ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ¤æ–­æ˜¯ `apt` è¿˜æ˜¯ `yum/dnf`ã€‚
    ```bash
    # æ‰¹é‡å®‰è£… git
    ansible web -m package -a "name=git state=present"
    ```

---

## 4. Playbook å®æˆ˜ï¼šNginx å·®å¼‚åŒ–éƒ¨ç½²

æˆ‘ç¼–å†™äº†ä¸€ä¸ªå‰§æœ¬ï¼Œä¸ä»…å®‰è£… Nginxï¼Œè¿˜åˆ©ç”¨ **Jinja2 æ¨¡æ¿**å®ç°äº†â€œåƒäººåƒé¢â€çš„ç½‘é¡µæ•ˆæœã€‚

### 4.1 ç¼–å†™æ¨¡æ¿ (`templates/index.html.j2`)
```html
<html>
<body>
    <h1>éƒ¨ç½²æˆåŠŸ!</h1>
    <!-- è‡ªåŠ¨å¡«å…¥å½“å‰æœºå™¨çš„ä¸»æœºå -->
    <p>æˆ‘æ˜¯ä¸»æœº: {{ ansible_hostname }}</p>
    <p>ç³»ç»Ÿ: {{ ansible_os_family }}</p>
</body>
</html>
```

### 4.2 ç¼–å†™å‰§æœ¬ (`deploy.yml`)
è¿™é‡Œå¤„ç†äº†ä¸€ä¸ªéš¾ç‚¹ï¼šUbuntu å’Œ Rocky çš„ Nginx é»˜è®¤ç½‘é¡µè·¯å¾„ä¸åŒã€‚æˆ‘ä½¿ç”¨äº† `when` æ¡ä»¶åˆ¤æ–­ã€‚

```yaml
---
- name: éƒ¨ç½² Nginx
  hosts: web
  tasks:
    - name: å®‰è£… Nginx
      package: name=nginx state=present

    - name: å‘å¸ƒé¦–é¡µ (Ubuntu)
      template:
        src: templates/index.html.j2
        dest: /var/www/html/index.html
      when: ansible_os_family == "Debian"

    - name: å‘å¸ƒé¦–é¡µ (Rocky)
      template:
        src: templates/index.html.j2
        dest: /usr/share/nginx/html/index.html
      when: ansible_os_family == "RedHat"
      
    - name: å¯åŠ¨æœåŠ¡
      service: name=nginx state=started enabled=yes
```

---

## 5. è¿›é˜¶æŒ‘æˆ˜ï¼šHAProxy è´Ÿè½½å‡è¡¡é›†ç¾¤

è¿™æ˜¯æœ¬æ¬¡å®éªŒæœ€é«˜å…‰çš„æ—¶åˆ»ã€‚æˆ‘å°†æ§åˆ¶èŠ‚ç‚¹ï¼ˆRocky-12ï¼‰é…ç½®ä¸ºè´Ÿè½½å‡è¡¡å™¨ï¼Œè‡ªåŠ¨åˆ†å‘æµé‡ç»™åç«¯çš„ Web æœåŠ¡å™¨ã€‚

### 5.1 åŠ¨æ€é…ç½®æ¨¡æ¿
éš¾ç‚¹åœ¨äºä¸èƒ½æŠŠåç«¯ IP å†™æ­»ã€‚æˆ‘ä½¿ç”¨äº† Jinja2 çš„ `for` å¾ªç¯éå† `[web]` ç»„ã€‚

**æ–‡ä»¶ï¼š`templates/haproxy.cfg.j2` (æ ¸å¿ƒç‰‡æ®µ)**
```jinja2
backend app_servers
    balance roundrobin
    # è‡ªåŠ¨éå† inventory ä¸­çš„ web ç»„
    {% for host in groups['web'] %}
    server {{ host }} {{ host }}:80 check
    {% endfor %}
```

### 5.2 æ•ˆæœéªŒè¯
éƒ¨ç½²å®Œæˆåï¼Œè®¿é—®è´Ÿè½½å‡è¡¡å™¨ç«¯å£ï¼Œå®ç°äº†è½®è¯¢æ•ˆæœï¼š
```bash
curl http://10.0.0.12:8080
# ç¬¬ä¸€æ¬¡è¿”å›ï¼šæˆ‘æ˜¯ä¸»æœº: ubuntu-13
# ç¬¬äºŒæ¬¡è¿”å›ï¼šæˆ‘æ˜¯ä¸»æœº: ubuntu-16
```

---

## 6. æ¶æ„é‡æ„ï¼šä½¿ç”¨ Roles (è§’è‰²)

éšç€ `yml` æ–‡ä»¶è¶Šæ¥è¶Šå¤šï¼Œç®¡ç†å˜å¾—æ··ä¹±ã€‚æˆ‘ä½¿ç”¨ Ansible Roles è¿›è¡Œäº†é‡æ„ã€‚

**æ“ä½œæ­¥éª¤ï¼š**
1.  **åˆå§‹åŒ–ï¼š** `ansible-galaxy init nginx`
2.  **æ‹†è§£ï¼š**
    *   å°† tasks ç§»åŠ¨åˆ° `roles/nginx/tasks/main.yml`
    *   å°† templates ç§»åŠ¨åˆ° `roles/nginx/templates/`
    *   å°† handlers ç§»åŠ¨åˆ° `roles/nginx/handlers/main.yml`
3.  **ä¸»å…¥å£ (`site.yml`):**
    ```yaml
    ---
    - hosts: web
      roles:
        - nginx
    ```

**å¿ƒå¾—ï¼š** é‡æ„åçš„ä»£ç ç»“æ„æ¸…æ™°ï¼Œå°±åƒæŠŠæ•£ä¹±çš„è¡£æœæ•´ç†è¿›äº†æ”¶çº³æŸœï¼Œéå¸¸é€‚åˆå¤§è§„æ¨¡ç»´æŠ¤ã€‚

---

## 7. å®‰å…¨åŠ å›ºï¼šAnsible Vault

ä¸ºäº†ä¸è®©ç®¡ç†å‘˜å¯†ç æ˜æ–‡æš´éœ²ï¼Œæˆ‘å­¦ä¹ äº†åŠ å¯†åŠŸèƒ½ã€‚

1.  **åˆ›å»ºåŠ å¯†æŸœï¼š**
    ```bash
    ansible-vault create secrets.yml
    # è¾“å…¥å¯†ç ï¼š123456
    # å†…å®¹ï¼šadmin_pass: "MySecretP@ssword"
    ```
2.  **ä½¿ç”¨åŠ å¯†å˜é‡ï¼š**
    åœ¨ playbook ä¸­åŠ è½½ `vars_files: secrets.yml`ã€‚
3.  **æ‰§è¡Œï¼š**
    ```bash
    ansible-playbook create_user.yml --ask-vault-pass
    ```

---

## 8. å¸¸è§æŠ¥é”™ä¸æ’æŸ¥ (Troubleshooting)

åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­é‡åˆ°çš„å‡ ä¸ªå…¸å‹æŠ¥é”™ï¼Œéå¸¸å…·æœ‰å‚è€ƒä»·å€¼ï¼š

1.  **[WARNING]: provided hosts list is empty**
    *   **åŸå› ï¼š** åœ¨éé¡¹ç›®ç›®å½•ä¸‹æ‰§è¡Œäº† `ansible` å‘½ä»¤ï¼Œå¯¼è‡´è¯»ä¸åˆ° `hosts` æ–‡ä»¶ã€‚
    *   **è§£å†³ï¼š** å¿…é¡»è¿›å…¥ `ansible.cfg` æ‰€åœ¨çš„ç›®å½•æ“ä½œã€‚
2.  **Syntax Error while loading YAML**
    *   **åŸå› ï¼š** å¤åˆ¶ç²˜è´´ä»£ç æ—¶ï¼Œç¼©è¿›é”™è¯¯ï¼Œæˆ–è€…æ–‡ä»¶å¼€å¤´å¤šå†™äº† `---`ã€‚
    *   **è§£å†³ï¼š** YAML å¯¹ç¼©è¿›æå…¶æ•æ„Ÿï¼ŒåŠ¡å¿…å¯¹é½ï¼›ä½¿ç”¨ `--syntax-check` å‚æ•°é¢„æ£€ã€‚
3.  **Command not found (curl)**
    *   **åŸå› ï¼š** æœ€å°åŒ–å®‰è£…çš„ Ubuntu ç¼ºå°‘ `curl` å‘½ä»¤ã€‚
    *   **è§£å†³ï¼š** ä½¿ç”¨ Ansible æ‰¹é‡è¡¥è£…ï¼š`ansible web -m package -a "name=curl state=present"`ã€‚

---

## ç»“è¯­

é€šè¿‡è¿™æ¬¡å®æˆ˜ï¼Œæˆ‘æ·±åˆ»ç†è§£äº† Ansible **"çº¦å®šå¤§äºé…ç½®"** çš„è®¾è®¡å“²å­¦ã€‚ä»ç®€å•çš„å‘½ä»¤æ‰§è¡Œï¼Œåˆ°å¤æ‚çš„é›†ç¾¤ç¼–æ’ï¼ŒAnsible æå¤§åœ°é‡Šæ”¾äº†è¿ç»´çš„ç”Ÿäº§åŠ›ã€‚

