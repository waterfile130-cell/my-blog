[{"categories":null,"content":"é›†ç¾¤ç¯å¢ƒ èŠ‚ç‚¹åç§° IP åœ°å€ æ“ä½œç³»ç»Ÿ è§’è‰² å…³é”®ç»„ä»¶ Rocky-12 10.0.0.12 Rocky Linux 9.4 LVS Master / Ansible Control Keepalived, ipvsadm, Ansible Rocky-15 10.0.0.15 Rocky Linux 9.4 LVS Backup Keepalived, ipvsadm Ubuntu-13 10.0.0.13 Ubuntu 24.04 Real Server (RS) Nginx (Web), ARP æŠ‘åˆ¶ Ubuntu-16 10.0.0.16 Ubuntu 24.04 Real Server (RS) Nginx (Web), ARP æŠ‘åˆ¶ VIP (Virtual IP)ï¼š 10.0.0.100 ","date":"2025-12-27","objectID":"/ansible-2.0/:1:0","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼š LVS+Keepalived çš„é«˜å¯ç”¨è´Ÿè½½å‡è¡¡é›†ç¾¤ä¸ Ansible è‡ªåŠ¨åŒ–è¿ç»´","uri":"/ansible-2.0/"},{"categories":null,"content":"ç¬¬ä¸€é˜¶æ®µï¼šKeepalived é«˜å¯ç”¨ (High Availability) ","date":"2025-12-27","objectID":"/ansible-2.0/:2:0","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼š LVS+Keepalived çš„é«˜å¯ç”¨è´Ÿè½½å‡è¡¡é›†ç¾¤ä¸ Ansible è‡ªåŠ¨åŒ–è¿ç»´","uri":"/ansible-2.0/"},{"categories":null,"content":"1.1 éƒ¨ç½²ç­–ç•¥ï¼šRPM vs Source ä¸ºäº†æŒæ¡ä¸åŒåœºæ™¯çš„éƒ¨ç½²èƒ½åŠ›ï¼Œé‡‡ç”¨åˆ†ç»„éƒ¨ç½²ç­–ç•¥ï¼š Rocky ç»„ï¼ˆå¿«é€Ÿäº¤ä»˜ï¼‰ï¼šç›´æ¥ä½¿ç”¨ dnf install keepalivedï¼Œæ¨¡æ‹Ÿä¼ä¸šæ ‡å‡†åŒ–ç¯å¢ƒã€‚ Ubuntu ç»„ï¼ˆæ·±åº¦å®šåˆ¶ï¼‰ï¼šä¸‹è½½ v2.2.8 æºç ï¼Œæ‰‹åŠ¨ç¼–è¯‘å®‰è£…ï¼Œè§£å†³ libssl-dev, libnl-3-dev ç­‰ä¾èµ–ï¼Œæ‰‹åŠ¨é…ç½® Systemd æœåŠ¡æ–‡ä»¶ã€‚ ","date":"2025-12-27","objectID":"/ansible-2.0/:2:1","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼š LVS+Keepalived çš„é«˜å¯ç”¨è´Ÿè½½å‡è¡¡é›†ç¾¤ä¸ Ansible è‡ªåŠ¨åŒ–è¿ç»´","uri":"/ansible-2.0/"},{"categories":null,"content":"1.2 æ ¸å¿ƒé…ç½®è§£æ é‡‡ç”¨ VRRPï¼ˆè™šæ‹Ÿè·¯ç”±å†—ä½™åè®®ï¼‰å®ç° VIP æ¼‚ç§»ã€‚ æŠ¢å æ¨¡å¼ï¼šMaster ä¼˜å…ˆçº§ä¸º 100ï¼ŒBackup ä¸º 90ï¼ŒMaster æ¢å¤åä¼šè‡ªåŠ¨æŠ¢å› VIPã€‚ ä¸šåŠ¡æ„ŸçŸ¥ï¼ˆHealth Checkï¼‰ï¼šKeepalived æœ¬èº«ä¸»è¦æ£€æµ‹è¿›ç¨‹/ä¸»æœºå­˜æ´»ï¼Œæ— æ³•ç›´æ¥æ„ŸçŸ¥ä¸šåŠ¡ï¼ˆä¾‹å¦‚ Nginxï¼‰ã€‚å¸¸ç”¨åšæ³•æ˜¯é…åˆ vrrp_script è°ƒç”¨è‡ªå®šä¹‰è„šæœ¬ï¼ˆä¾‹å¦‚ check_nginx.shï¼‰ï¼Œå½“ Nginx ä¸å¯ç”¨æ—¶é™ä½æƒé‡è§¦å‘åˆ‡æ¢ã€‚ ç¤ºä¾‹ï¼šcheck_nginx.sh #!/bin/bash if ! pgrep -x nginx \u003e/dev/null; then exit 1 fi exit 0 åœ¨ keepalived.conf ä¸­å¯ä»¥é€šè¿‡ vrrp_script + track_script é…ç½®æƒé‡å˜åŒ–ã€‚ ","date":"2025-12-27","objectID":"/ansible-2.0/:2:2","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼š LVS+Keepalived çš„é«˜å¯ç”¨è´Ÿè½½å‡è¡¡é›†ç¾¤ä¸ Ansible è‡ªåŠ¨åŒ–è¿ç»´","uri":"/ansible-2.0/"},{"categories":null,"content":"1.3 æ•…éšœæ¼”ç»ƒï¼ˆChaos Engineeringï¼‰ æ‹”çº¿æµ‹è¯•ï¼šåœæ­¢ Master çš„ Keepalived æœåŠ¡ï¼ŒVIP ç§’çº§æ¼‚ç§»è‡³ Backupï¼Œä¸šåŠ¡ä¸ä¸­æ–­ã€‚ è„‘è£‚å¤ç°ï¼šé€šè¿‡é˜²ç«å¢™é˜»æ–­ VRRP ç»„æ’­åŒ…ï¼Œå¤ç°â€œåŒä¸»â€å¯¼è‡´ IP å†²çªçš„åœºæ™¯ã€‚ ","date":"2025-12-27","objectID":"/ansible-2.0/:2:3","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼š LVS+Keepalived çš„é«˜å¯ç”¨è´Ÿè½½å‡è¡¡é›†ç¾¤ä¸ Ansible è‡ªåŠ¨åŒ–è¿ç»´","uri":"/ansible-2.0/"},{"categories":null,"content":"ç¬¬äºŒé˜¶æ®µï¼šLVS-DR è´Ÿè½½å‡è¡¡ (Load Balancing) ","date":"2025-12-27","objectID":"/ansible-2.0/:3:0","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼š LVS+Keepalived çš„é«˜å¯ç”¨è´Ÿè½½å‡è¡¡é›†ç¾¤ä¸ Ansible è‡ªåŠ¨åŒ–è¿ç»´","uri":"/ansible-2.0/"},{"categories":null,"content":"2.1 æ¶æ„å‡çº§ ç”± Active-Standby å‡çº§ä¸º LVS-DRï¼ˆDirect Routingï¼‰ã€‚æµé‡èµ°å‘ï¼šClient -\u003e VIP -\u003e LVS -\u003e RS -\u003e Clientã€‚ä¼˜ç‚¹æ˜¯å›åŒ…ä¸ç»è¿‡ LVSï¼Œæé«˜ååã€‚ ","date":"2025-12-27","objectID":"/ansible-2.0/:3:1","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼š LVS+Keepalived çš„é«˜å¯ç”¨è´Ÿè½½å‡è¡¡é›†ç¾¤ä¸ Ansible è‡ªåŠ¨åŒ–è¿ç»´","uri":"/ansible-2.0/"},{"categories":null,"content":"2.2 å…³é”®æŠ€æœ¯éš¾ç‚¹ï¼šARP æŠ‘åˆ¶ åœ¨ DR æ¨¡å¼ä¸‹ï¼ŒLVS ä¸ RS éƒ½å­˜åœ¨ VIPï¼Œä¸ºé¿å… IP å†²çªï¼Œéœ€è¦åœ¨ RS ä¸Šè¿›è¡Œ ARP æŠ‘åˆ¶ï¼Œå¹¶å°† VIP ç»‘å®šåˆ°å›ç¯æ¥å£ï¼ˆloï¼‰ã€‚å¸¸ç”¨å†…æ ¸å‚æ•°ï¼š # å…³é”®å†…æ ¸å‚æ•°ï¼ˆç¤ºä¾‹ï¼‰ sysctl -w net.ipv4.conf.lo.arp_ignore=1 sysctl -w net.ipv4.conf.lo.arp_announce=2 sysctl -w net.ipv4.conf.all.arp_ignore=1 sysctl -w net.ipv4.conf.all.arp_announce=2 æ’é”™è®°å½•ï¼šUbuntu 24.04 å¯èƒ½ç¼ºå°‘ ifconfigï¼ˆæ¥è‡ª net-toolsï¼‰ï¼Œå»ºè®®ä½¿ç”¨ ip addr add æˆ–å®‰è£… net-toolsã€‚ ","date":"2025-12-27","objectID":"/ansible-2.0/:3:2","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼š LVS+Keepalived çš„é«˜å¯ç”¨è´Ÿè½½å‡è¡¡é›†ç¾¤ä¸ Ansible è‡ªåŠ¨åŒ–è¿ç»´","uri":"/ansible-2.0/"},{"categories":null,"content":"2.3 éªŒè¯æŠ€å·§ æµè§ˆå™¨å­˜åœ¨é•¿è¿æ¥/ç¼“å­˜é™·é˜±ï¼Œåˆ·æ–°å¯èƒ½ä»è®¿é—®åŒä¸€åç«¯ã€‚æ­£ç¡®åŠæ³•ä½¿ç”¨ curl ç­‰çŸ­è¿æ¥å·¥å…·è¿›è¡ŒéªŒè¯ï¼Œä»¥è§‚å¯Ÿè½®è¯¢/è°ƒåº¦æ•ˆæœã€‚ ","date":"2025-12-27","objectID":"/ansible-2.0/:3:3","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼š LVS+Keepalived çš„é«˜å¯ç”¨è´Ÿè½½å‡è¡¡é›†ç¾¤ä¸ Ansible è‡ªåŠ¨åŒ–è¿ç»´","uri":"/ansible-2.0/"},{"categories":null,"content":"ç¬¬ä¸‰é˜¶æ®µï¼šAnsible è‡ªåŠ¨åŒ–è¿ç»´ (Automation) ","date":"2025-12-27","objectID":"/ansible-2.0/:4:0","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼š LVS+Keepalived çš„é«˜å¯ç”¨è´Ÿè½½å‡è¡¡é›†ç¾¤ä¸ Ansible è‡ªåŠ¨åŒ–è¿ç»´","uri":"/ansible-2.0/"},{"categories":null,"content":"3.1 ä¿¡ä»»æ„å»º åœ¨æ§åˆ¶æœºï¼ˆRocky-12ï¼‰ç”Ÿæˆ SSH Keyï¼ˆssh-keygenï¼‰ï¼Œä½¿ç”¨ ssh-copy-id å°†å…¬é’¥åˆ†å‘åˆ°è¢«æ§æœºï¼Œå»ºç«‹å…å¯†è¿é€šæ€§ã€‚ ","date":"2025-12-27","objectID":"/ansible-2.0/:4:1","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼š LVS+Keepalived çš„é«˜å¯ç”¨è´Ÿè½½å‡è¡¡é›†ç¾¤ä¸ Ansible è‡ªåŠ¨åŒ–è¿ç»´","uri":"/ansible-2.0/"},{"categories":null,"content":"3.2 Playbook å®æˆ˜ï¼ˆInfrastructure as Codeï¼‰ Inventory åˆ†ç»„ä¸º [lb]ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰ä¸ [web]ï¼ˆåç«¯ï¼‰ã€‚ ä½¿ç”¨æ¨¡å—åŒ– Playbookï¼šè‡ªåŠ¨è¯†åˆ« yum / aptï¼Œå®‰è£…è½¯ä»¶ï¼›ä½¿ç”¨ userã€copy ç­‰æ¨¡å—ç»Ÿä¸€ç®¡ç†ç”¨æˆ·å’Œé…ç½®æ–‡ä»¶ã€‚ å¹‚ç­‰æ€§ï¼šå¤šæ¬¡æ‰§è¡Œ Playbookï¼Œç³»ç»ŸçŠ¶æ€ä¿æŒä¸€è‡´ï¼Œæœªå‘ç”Ÿé…ç½®æ¼‚ç§»ã€‚ ","date":"2025-12-27","objectID":"/ansible-2.0/:4:2","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼š LVS+Keepalived çš„é«˜å¯ç”¨è´Ÿè½½å‡è¡¡é›†ç¾¤ä¸ Ansible è‡ªåŠ¨åŒ–è¿ç»´","uri":"/ansible-2.0/"},{"categories":null,"content":"æ€»ç»“ æœ¬æ¬¡å®æˆ˜æ­å»ºäº†ä¸€å¥—å…·å¤‡é«˜å¯ç”¨ï¼ˆHAï¼‰ã€é«˜æ€§èƒ½ï¼ˆLBï¼‰ä¸å¯ç®¡ç†ï¼ˆAutomationï¼‰ç‰¹æ€§çš„åŸºç¡€æ¶æ„ã€‚è§£å†³äº†è·¨ç³»ç»Ÿå…¼å®¹ã€ç½‘ç»œåè®®å†²çªä¸é•¿è¿æ¥éªŒè¯ç­‰è¿ç»´ç—›ç‚¹ã€‚ â€“ ","date":"2025-12-27","objectID":"/ansible-2.0/:5:0","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼š LVS+Keepalived çš„é«˜å¯ç”¨è´Ÿè½½å‡è¡¡é›†ç¾¤ä¸ Ansible è‡ªåŠ¨åŒ–è¿ç»´","uri":"/ansible-2.0/"},{"categories":null,"content":"ğŸ¤– æœºå™¨äººè‡ªåŠ¨æ’­æŠ¥ åŒ—äº¬æ—¶é—´ï¼š2025-12-27 09:11:48 ä»Šæ—¥å¤©æ°”ï¼š Beijing: â˜€ï¸ -2Â°C (æœ¬æ–‡ç« ç”± GitHub Actions è‡ªåŠ¨æŠ“å–å¹¶å‘å¸ƒ) ","date":"2025-12-27","objectID":"/weather-2025-12-27/:1:0","tags":["è‡ªåŠ¨æ’­æŠ¥","å¤©æ°”"],"title":"ğŸ“… 2025-12-27 æ¯æ—¥å¤©æ°”æ’­æŠ¥","uri":"/weather-2025-12-27/"},{"categories":null,"content":"ğŸ¤– æœºå™¨äººè‡ªåŠ¨æ’­æŠ¥ åŒ—äº¬æ—¶é—´ï¼š2025-12-26 09:13:47 ä»Šæ—¥å¤©æ°”ï¼š Beijing: â˜€ï¸ -4Â°C (æœ¬æ–‡ç« ç”± GitHub Actions è‡ªåŠ¨æŠ“å–å¹¶å‘å¸ƒ) ","date":"2025-12-26","objectID":"/weather-2025-12-26/:1:0","tags":["è‡ªåŠ¨æ’­æŠ¥","å¤©æ°”"],"title":"ğŸ“… 2025-12-26 æ¯æ—¥å¤©æ°”æ’­æŠ¥","uri":"/weather-2025-12-26/"},{"categories":null,"content":"1. å®éªŒç¯å¢ƒè§„åˆ’ æˆ‘ä½¿ç”¨äº† 3 å°è™šæ‹Ÿæœºï¼Œæ“ä½œç³»ç»Ÿæ¶µç›–äº† RHEL ç³»å’Œ Debian ç³»ï¼Œä»¥æµ‹è¯• Ansible å¯¹å¼‚æ„ç³»ç»Ÿçš„å…¼å®¹æ€§ã€‚ ","date":"2025-12-25","objectID":"/ansible/:1:0","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼šæ„å»ºè‡ªåŠ¨åŒ–è¿ç»´é›†ç¾¤ï¼ˆNginx + HAProxy + Rolesï¼‰","uri":"/ansible/"},{"categories":null,"content":"1. å®éªŒç¯å¢ƒè§„åˆ’ æˆ‘ä½¿ç”¨äº† 3 å°è™šæ‹Ÿæœºï¼Œæ“ä½œç³»ç»Ÿæ¶µç›–äº† RHEL ç³»å’Œ Debian ç³»ï¼Œä»¥æµ‹è¯• Ansible å¯¹å¼‚æ„ç³»ç»Ÿçš„å…¼å®¹æ€§ã€‚ ä¸»æœºå IP åœ°å€ è§’è‰² æ“ä½œç³»ç»Ÿ å¤‡æ³¨ Rocky-12 10.0.0.12 æ§åˆ¶èŠ‚ç‚¹ (Ansible Server) è´Ÿè½½å‡è¡¡å™¨ (HAProxy) Rocky Linux 9 æŒ‡æŒ¥å®˜ï¼Œæ‰€æœ‰å‘½ä»¤åœ¨æ­¤æ‰§è¡Œ Ubuntu-13 10.0.0.13 è¢«æ§èŠ‚ç‚¹ (Web Server) Ubuntu 24.04 è¿è¡Œ Nginx Ubuntu-16 10.0.0.16 è¢«æ§èŠ‚ç‚¹ (Web Server) Ubuntu 24.04 è¿è¡Œ Nginx ","date":"2025-12-25","objectID":"/ansible/:1:1","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼šæ„å»ºè‡ªåŠ¨åŒ–è¿ç»´é›†ç¾¤ï¼ˆNginx + HAProxy + Rolesï¼‰","uri":"/ansible/"},{"categories":null,"content":"2. åŸºç¡€ç¯å¢ƒé…ç½® (The Foundation) ","date":"2025-12-25","objectID":"/ansible/:2:0","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼šæ„å»ºè‡ªåŠ¨åŒ–è¿ç»´é›†ç¾¤ï¼ˆNginx + HAProxy + Rolesï¼‰","uri":"/ansible/"},{"categories":null,"content":"2.1 å®‰è£… Ansible Ansible æ˜¯æ— ä»£ç†ï¼ˆAgentlessï¼‰çš„ï¼Œåªéœ€è¦åœ¨æ§åˆ¶èŠ‚ç‚¹å®‰è£…å³å¯ã€‚ # åœ¨ Rocky 9 æ§åˆ¶èŠ‚ç‚¹ä¸Š sudo dnf install epel-release -y sudo dnf install ansible -y ","date":"2025-12-25","objectID":"/ansible/:2:1","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼šæ„å»ºè‡ªåŠ¨åŒ–è¿ç»´é›†ç¾¤ï¼ˆNginx + HAProxy + Rolesï¼‰","uri":"/ansible/"},{"categories":null,"content":"2.2 SSH å…å¯†äº’ä¿¡ (è¸©å‘è®°å½•) è¿™æ˜¯ Ansible é€šä¿¡çš„åŸºç¡€ã€‚ è¸©å‘ï¼š ä¸€å¼€å§‹ä½¿ç”¨äº† ssh-keygen -p å¯¼è‡´æŠ¥é”™ï¼Œåæ¥å‘ç°å°å†™ -p æ˜¯ä¿®æ”¹å¯†ç ï¼Œå¤§å†™ -P æ‰æ˜¯è®¾ç½®æ–°å¯†ç ï¼ˆç©ºå¯†ç ï¼‰ã€‚ æ­£ç¡®æ“ä½œï¼š # 1. ç”Ÿæˆå¯†é’¥ (ä¸€è·¯å›è½¦) ssh-keygen -t rsa -P '' -f ~/.ssh/id_rsa # 2. åˆ†å‘å…¬é’¥åˆ°æ‰€æœ‰èŠ‚ç‚¹ (åŒ…æ‹¬è‡ªå·±) ssh-copy-id root@10.0.0.12 ssh-copy-id root@10.0.0.13 ssh-copy-id root@10.0.0.16 ","date":"2025-12-25","objectID":"/ansible/:2:2","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼šæ„å»ºè‡ªåŠ¨åŒ–è¿ç»´é›†ç¾¤ï¼ˆNginx + HAProxy + Rolesï¼‰","uri":"/ansible/"},{"categories":null,"content":"2.3 æ„å»º Inventory (èŠ±åå†Œ) ä¸ºäº†ä¸æ±¡æŸ“ç³»ç»Ÿé…ç½®ï¼Œæˆ‘åœ¨é¡¹ç›®ç›®å½•å»ºç«‹äº†ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ã€‚ æ–‡ä»¶ç»“æ„ï¼š /root/ansible_start/ hosts (æ¸…å•æ–‡ä»¶): [web] 10.0.0.13 10.0.0.16 [lb] 10.0.0.12 ansible.cfg (é…ç½®æ–‡ä»¶): [defaults] inventory = ./hosts host_key_checking = False # å…³é”®é…ç½®ï¼šè·³è¿‡ SSH æŒ‡çº¹éªŒè¯ ","date":"2025-12-25","objectID":"/ansible/:2:3","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼šæ„å»ºè‡ªåŠ¨åŒ–è¿ç»´é›†ç¾¤ï¼ˆNginx + HAProxy + Rolesï¼‰","uri":"/ansible/"},{"categories":null,"content":"3. Ad-Hoc å‘½ä»¤ä½“éªŒ åœ¨å†™å‰§æœ¬å‰ï¼Œå…ˆç”¨å•è¡Œå‘½ä»¤æµ‹è¯•è¿æ¥ã€‚ è¿é€šæ€§æµ‹è¯•ï¼š ansible all -m ping è·¨å¹³å°å®‰è£…è½¯ä»¶ (æ··åˆåŒæ‰“)ï¼š ä½¿ç”¨ package æ¨¡å—ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ¤æ–­æ˜¯ apt è¿˜æ˜¯ yum/dnfã€‚ # æ‰¹é‡å®‰è£… git ansible web -m package -a \"name=git state=present\" ","date":"2025-12-25","objectID":"/ansible/:3:0","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼šæ„å»ºè‡ªåŠ¨åŒ–è¿ç»´é›†ç¾¤ï¼ˆNginx + HAProxy + Rolesï¼‰","uri":"/ansible/"},{"categories":null,"content":"4. Playbook å®æˆ˜ï¼šNginx å·®å¼‚åŒ–éƒ¨ç½² æˆ‘ç¼–å†™äº†ä¸€ä¸ªå‰§æœ¬ï¼Œä¸ä»…å®‰è£… Nginxï¼Œè¿˜åˆ©ç”¨ Jinja2 æ¨¡æ¿å®ç°äº†â€œåƒäººåƒé¢â€çš„ç½‘é¡µæ•ˆæœã€‚ ","date":"2025-12-25","objectID":"/ansible/:4:0","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼šæ„å»ºè‡ªåŠ¨åŒ–è¿ç»´é›†ç¾¤ï¼ˆNginx + HAProxy + Rolesï¼‰","uri":"/ansible/"},{"categories":null,"content":"4.1 ç¼–å†™æ¨¡æ¿ (templates/index.html.j2) \u003chtml\u003e \u003cbody\u003e \u003ch1\u003eéƒ¨ç½²æˆåŠŸ!\u003c/h1\u003e \u003c!-- è‡ªåŠ¨å¡«å…¥å½“å‰æœºå™¨çš„ä¸»æœºå --\u003e \u003cp\u003eæˆ‘æ˜¯ä¸»æœº: {{ ansible_hostname }}\u003c/p\u003e \u003cp\u003eç³»ç»Ÿ: {{ ansible_os_family }}\u003c/p\u003e \u003c/body\u003e \u003c/html\u003e ","date":"2025-12-25","objectID":"/ansible/:4:1","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼šæ„å»ºè‡ªåŠ¨åŒ–è¿ç»´é›†ç¾¤ï¼ˆNginx + HAProxy + Rolesï¼‰","uri":"/ansible/"},{"categories":null,"content":"4.2 ç¼–å†™å‰§æœ¬ (deploy.yml) è¿™é‡Œå¤„ç†äº†ä¸€ä¸ªéš¾ç‚¹ï¼šUbuntu å’Œ Rocky çš„ Nginx é»˜è®¤ç½‘é¡µè·¯å¾„ä¸åŒã€‚æˆ‘ä½¿ç”¨äº† when æ¡ä»¶åˆ¤æ–­ã€‚ --- - name: éƒ¨ç½² Nginx hosts: web tasks: - name: å®‰è£… Nginx package: name=nginx state=present - name: å‘å¸ƒé¦–é¡µ (Ubuntu) template: src: templates/index.html.j2 dest: /var/www/html/index.html when: ansible_os_family == \"Debian\" - name: å‘å¸ƒé¦–é¡µ (Rocky) template: src: templates/index.html.j2 dest: /usr/share/nginx/html/index.html when: ansible_os_family == \"RedHat\" - name: å¯åŠ¨æœåŠ¡ service: name=nginx state=started enabled=yes ","date":"2025-12-25","objectID":"/ansible/:4:2","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼šæ„å»ºè‡ªåŠ¨åŒ–è¿ç»´é›†ç¾¤ï¼ˆNginx + HAProxy + Rolesï¼‰","uri":"/ansible/"},{"categories":null,"content":"5. è¿›é˜¶æŒ‘æˆ˜ï¼šHAProxy è´Ÿè½½å‡è¡¡é›†ç¾¤ è¿™æ˜¯æœ¬æ¬¡å®éªŒæœ€é«˜å…‰çš„æ—¶åˆ»ã€‚æˆ‘å°†æ§åˆ¶èŠ‚ç‚¹ï¼ˆRocky-12ï¼‰é…ç½®ä¸ºè´Ÿè½½å‡è¡¡å™¨ï¼Œè‡ªåŠ¨åˆ†å‘æµé‡ç»™åç«¯çš„ Web æœåŠ¡å™¨ã€‚ ","date":"2025-12-25","objectID":"/ansible/:5:0","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼šæ„å»ºè‡ªåŠ¨åŒ–è¿ç»´é›†ç¾¤ï¼ˆNginx + HAProxy + Rolesï¼‰","uri":"/ansible/"},{"categories":null,"content":"5.1 åŠ¨æ€é…ç½®æ¨¡æ¿ éš¾ç‚¹åœ¨äºä¸èƒ½æŠŠåç«¯ IP å†™æ­»ã€‚æˆ‘ä½¿ç”¨äº† Jinja2 çš„ for å¾ªç¯éå† [web] ç»„ã€‚ æ–‡ä»¶ï¼štemplates/haproxy.cfg.j2 (æ ¸å¿ƒç‰‡æ®µ) backend app_servers balance roundrobin # è‡ªåŠ¨éå† inventory ä¸­çš„ web ç»„ {% for host in groups['web'] %} server {{ host }} {{ host }}:80 check {% endfor %} ","date":"2025-12-25","objectID":"/ansible/:5:1","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼šæ„å»ºè‡ªåŠ¨åŒ–è¿ç»´é›†ç¾¤ï¼ˆNginx + HAProxy + Rolesï¼‰","uri":"/ansible/"},{"categories":null,"content":"5.2 æ•ˆæœéªŒè¯ éƒ¨ç½²å®Œæˆåï¼Œè®¿é—®è´Ÿè½½å‡è¡¡å™¨ç«¯å£ï¼Œå®ç°äº†è½®è¯¢æ•ˆæœï¼š curl http://10.0.0.12:8080 # ç¬¬ä¸€æ¬¡è¿”å›ï¼šæˆ‘æ˜¯ä¸»æœº: ubuntu-13 # ç¬¬äºŒæ¬¡è¿”å›ï¼šæˆ‘æ˜¯ä¸»æœº: ubuntu-16 ","date":"2025-12-25","objectID":"/ansible/:5:2","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼šæ„å»ºè‡ªåŠ¨åŒ–è¿ç»´é›†ç¾¤ï¼ˆNginx + HAProxy + Rolesï¼‰","uri":"/ansible/"},{"categories":null,"content":"6. æ¶æ„é‡æ„ï¼šä½¿ç”¨ Roles (è§’è‰²) éšç€ yml æ–‡ä»¶è¶Šæ¥è¶Šå¤šï¼Œç®¡ç†å˜å¾—æ··ä¹±ã€‚æˆ‘ä½¿ç”¨ Ansible Roles è¿›è¡Œäº†é‡æ„ã€‚ æ“ä½œæ­¥éª¤ï¼š åˆå§‹åŒ–ï¼š ansible-galaxy init nginx æ‹†è§£ï¼š å°† tasks ç§»åŠ¨åˆ° roles/nginx/tasks/main.yml å°† templates ç§»åŠ¨åˆ° roles/nginx/templates/ å°† handlers ç§»åŠ¨åˆ° roles/nginx/handlers/main.yml ä¸»å…¥å£ (site.yml): --- - hosts: web roles: - nginx å¿ƒå¾—ï¼š é‡æ„åçš„ä»£ç ç»“æ„æ¸…æ™°ï¼Œå°±åƒæŠŠæ•£ä¹±çš„è¡£æœæ•´ç†è¿›äº†æ”¶çº³æŸœï¼Œéå¸¸é€‚åˆå¤§è§„æ¨¡ç»´æŠ¤ã€‚ ","date":"2025-12-25","objectID":"/ansible/:6:0","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼šæ„å»ºè‡ªåŠ¨åŒ–è¿ç»´é›†ç¾¤ï¼ˆNginx + HAProxy + Rolesï¼‰","uri":"/ansible/"},{"categories":null,"content":"7. å®‰å…¨åŠ å›ºï¼šAnsible Vault ä¸ºäº†ä¸è®©ç®¡ç†å‘˜å¯†ç æ˜æ–‡æš´éœ²ï¼Œæˆ‘å­¦ä¹ äº†åŠ å¯†åŠŸèƒ½ã€‚ åˆ›å»ºåŠ å¯†æŸœï¼š ansible-vault create secrets.yml # è¾“å…¥å¯†ç ï¼š123456 # å†…å®¹ï¼šadmin_pass: \"MySecretP@ssword\" ä½¿ç”¨åŠ å¯†å˜é‡ï¼š åœ¨ playbook ä¸­åŠ è½½ vars_files: secrets.ymlã€‚ æ‰§è¡Œï¼š ansible-playbook create_user.yml --ask-vault-pass ","date":"2025-12-25","objectID":"/ansible/:7:0","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼šæ„å»ºè‡ªåŠ¨åŒ–è¿ç»´é›†ç¾¤ï¼ˆNginx + HAProxy + Rolesï¼‰","uri":"/ansible/"},{"categories":null,"content":"8. å¸¸è§æŠ¥é”™ä¸æ’æŸ¥ (Troubleshooting) åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­é‡åˆ°çš„å‡ ä¸ªå…¸å‹æŠ¥é”™ï¼Œéå¸¸å…·æœ‰å‚è€ƒä»·å€¼ï¼š [WARNING]: provided hosts list is empty åŸå› ï¼š åœ¨éé¡¹ç›®ç›®å½•ä¸‹æ‰§è¡Œäº† ansible å‘½ä»¤ï¼Œå¯¼è‡´è¯»ä¸åˆ° hosts æ–‡ä»¶ã€‚ è§£å†³ï¼š å¿…é¡»è¿›å…¥ ansible.cfg æ‰€åœ¨çš„ç›®å½•æ“ä½œã€‚ Syntax Error while loading YAML åŸå› ï¼š å¤åˆ¶ç²˜è´´ä»£ç æ—¶ï¼Œç¼©è¿›é”™è¯¯ï¼Œæˆ–è€…æ–‡ä»¶å¼€å¤´å¤šå†™äº† ---ã€‚ è§£å†³ï¼š YAML å¯¹ç¼©è¿›æå…¶æ•æ„Ÿï¼ŒåŠ¡å¿…å¯¹é½ï¼›ä½¿ç”¨ --syntax-check å‚æ•°é¢„æ£€ã€‚ Command not found (curl) åŸå› ï¼š æœ€å°åŒ–å®‰è£…çš„ Ubuntu ç¼ºå°‘ curl å‘½ä»¤ã€‚ è§£å†³ï¼š ä½¿ç”¨ Ansible æ‰¹é‡è¡¥è£…ï¼šansible web -m package -a \"name=curl state=present\"ã€‚ ","date":"2025-12-25","objectID":"/ansible/:8:0","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼šæ„å»ºè‡ªåŠ¨åŒ–è¿ç»´é›†ç¾¤ï¼ˆNginx + HAProxy + Rolesï¼‰","uri":"/ansible/"},{"categories":null,"content":"ç»“è¯­ é€šè¿‡è¿™æ¬¡å®æˆ˜ï¼Œæˆ‘æ·±åˆ»ç†è§£äº† Ansible â€œçº¦å®šå¤§äºé…ç½®â€ çš„è®¾è®¡å“²å­¦ã€‚ä»ç®€å•çš„å‘½ä»¤æ‰§è¡Œï¼Œåˆ°å¤æ‚çš„é›†ç¾¤ç¼–æ’ï¼ŒAnsible æå¤§åœ°é‡Šæ”¾äº†è¿ç»´çš„ç”Ÿäº§åŠ›ã€‚ ","date":"2025-12-25","objectID":"/ansible/:9:0","tags":null,"title":"ğŸš€ Ansible ç¬”è®°ï¼šæ„å»ºè‡ªåŠ¨åŒ–è¿ç»´é›†ç¾¤ï¼ˆNginx + HAProxy + Rolesï¼‰","uri":"/ansible/"},{"categories":null,"content":"ğŸ¤– æœºå™¨äººè‡ªåŠ¨æ’­æŠ¥ åŒ—äº¬æ—¶é—´ï¼š2025-12-25 09:13:20 ä»Šæ—¥å¤©æ°”ï¼š Beijing: â˜€ï¸ -5Â°C (æœ¬æ–‡ç« ç”± GitHub Actions è‡ªåŠ¨æŠ“å–å¹¶å‘å¸ƒ) ","date":"2025-12-25","objectID":"/weather-2025-12-25/:1:0","tags":["è‡ªåŠ¨æ’­æŠ¥","å¤©æ°”"],"title":"ğŸ“… 2025-12-25 æ¯æ—¥å¤©æ°”æ’­æŠ¥","uri":"/weather-2025-12-25/"},{"categories":null,"content":"ğŸ¤– æœºå™¨äººè‡ªåŠ¨æ’­æŠ¥ åŒ—äº¬æ—¶é—´ï¼š2025-12-24 09:12:41 ä»Šæ—¥å¤©æ°”ï¼š Beijing: â˜€ï¸ -9Â°C (æœ¬æ–‡ç« ç”± GitHub Actions è‡ªåŠ¨æŠ“å–å¹¶å‘å¸ƒ) ","date":"2025-12-24","objectID":"/weather-2025-12-24/:1:0","tags":["è‡ªåŠ¨æ’­æŠ¥","å¤©æ°”"],"title":"ğŸ“… 2025-12-24 æ¯æ—¥å¤©æ°”æ’­æŠ¥","uri":"/weather-2025-12-24/"},{"categories":["Tech"],"content":"keepalivedåŸºç¡€çŸ¥è¯†","date":"2025-12-23","objectID":"/whats-keepalived/","tags":["Linux","è¿ç»´","é«˜å¯ç”¨é›†ç¾¤"],"title":"keepalived","uri":"/whats-keepalived/"},{"categories":["Tech"],"content":"1. ä»€ä¹ˆæ˜¯é«˜å¯ç”¨ (High Availability, HA)ï¼Ÿ åœ¨ IT é¢†åŸŸï¼Œâ€˜é«˜å¯ç”¨â€™æŒ‡çš„æ˜¯ç³»ç»Ÿåœ¨é¢å¯¹ç¡¬ä»¶æ•…éšœã€è½¯ä»¶é”™è¯¯æˆ–ç½‘ç»œé—®é¢˜æ—¶ï¼Œä»èƒ½é•¿æ—¶é—´æŒç»­æä¾›æœåŠ¡çš„èƒ½åŠ›ã€‚ 'ç›®æ ‡'ï¼šæ¶ˆé™¤å•ç‚¹æ•…éšœï¼ˆSPOFï¼‰ã€‚å¦‚æœä¸€å°æœåŠ¡å™¨æŒ‚äº†ï¼Œå¦ä¸€å°èƒ½ç«‹é©¬é¡¶ä¸Šã€‚ 'è¡¡é‡æ ‡å‡†'ï¼šé€šå¸¸ç”¨â€œå‡ ä¸ª9â€æ¥è¡¡é‡ï¼Œæ¯”å¦‚ 99.99%ï¼ˆæ„å‘³ç€ä¸€å¹´åœæœºæ—¶é—´ä¸è¶…è¿‡ 52 åˆ†é’Ÿï¼‰ã€‚ â€˜Keepalivedâ€™ å°±æ˜¯Linuxä¸‹ä¸€ä¸ªè½»é‡çº§çš„é«˜å¯ç”¨è§£å†³æ–¹æ¡ˆï¼Œå®ƒæœ€åˆæ˜¯ä¸º LVSï¼ˆLinux Virtual Serverï¼‰è®¾è®¡çš„ï¼Œç”¨æ¥ç®¡ç†å¹¶ç›‘æ§è´Ÿè½½å‡è¡¡é›†ç¾¤ä¸­çš„æœåŠ¡èŠ‚ç‚¹çŠ¶æ€ã€‚ ","date":"2025-12-23","objectID":"/whats-keepalived/:0:1","tags":["Linux","è¿ç»´","é«˜å¯ç”¨é›†ç¾¤"],"title":"keepalived","uri":"/whats-keepalived/"},{"categories":["Tech"],"content":"2. æ ¸å¿ƒåŸºçŸ³ï¼šVRRP åè®® è¦æ‡‚ Keepalivedï¼Œå¿…é¡»å…ˆæ‡‚ â€˜VRRPâ€™ (Virtual Router Redundancy Protocolï¼Œè™šæ‹Ÿè·¯ç”±å™¨å†—ä½™åè®®)ã€‚Keepalived å°±æ˜¯ç”¨ C è¯­è¨€å®ç°äº† VRRP åè®®ã€‚ VRRP çš„å·¥ä½œåŸç†ï¼š æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æœ‰ä¸€ç¾¤è·¯ç”±å™¨ï¼Œæˆ‘ä»¬æƒ³è®©å®ƒä»¬åœ¨å¤–é¢çœ‹èµ·æ¥åƒâ€™ä¸€å°â€™è¶…çº§è·¯ç”±å™¨ã€‚ â€˜è™šæ‹Ÿ IP (VIP)â€™ï¼šè¿™æ˜¯å¯¹å¤–æä¾›æœåŠ¡çš„ IP åœ°å€ã€‚å®¢æˆ·ç«¯åªè¿æ¥è¿™ä¸ª IPï¼Œä¸çŸ¥é“åé¢å…·ä½“æ˜¯å“ªå°æœºå™¨ã€‚ â€˜è§’è‰²â€™ï¼š â€™ â€˜Master (ä¸»èŠ‚ç‚¹)â€™ï¼šçœŸæ­£æŒæœ‰ VIPï¼Œè´Ÿè´£å¤„ç†æµé‡ï¼Œå¹¶å‘¨æœŸæ€§åœ°å‘ Backup å‘é€â€œæˆ‘è¿˜æ´»ç€â€çš„å¹¿æ’­åŒ…ï¼ˆå¿ƒè·³ï¼‰ã€‚ â€™ â€˜Backup (å¤‡èŠ‚ç‚¹)â€™ï¼šç›‘å¬ Master çš„å¹¿æ’­ã€‚ â€˜é€‰ä¸¾ä¸æ•…éšœåˆ‡æ¢ (Failover)â€™ï¼š â€™ Backup å¦‚æœåœ¨ä¸€å®šæ—¶é—´å†…ï¼ˆé€šå¸¸æ˜¯3ç§’ï¼‰æ”¶ä¸åˆ° Master çš„å¿ƒè·³åŒ…ï¼Œå°±è®¤ä¸º Master æŒ‚äº†ã€‚ â€™ Backup æ ¹æ®ä¼˜å…ˆçº§ï¼ˆPriorityï¼‰é€‰ä¸¾å‡ºæ–°çš„ Masterï¼Œæ¥ç®¡ VIPã€‚ â€™ ä¸€æ—¦æ—§ Master æ¢å¤ï¼Œæ ¹æ®é…ç½®ï¼ˆæŠ¢å æ¨¡å¼ï¼‰ï¼Œå®ƒå¯èƒ½ä¼šé‡æ–°å¤ºå› VIPã€‚ ","date":"2025-12-23","objectID":"/whats-keepalived/:0:2","tags":["Linux","è¿ç»´","é«˜å¯ç”¨é›†ç¾¤"],"title":"keepalived","uri":"/whats-keepalived/"},{"categories":["Tech"],"content":"3. Keepalived åŸºç¡€çŸ¥è¯† Keepalived ä¸»è¦æœ‰ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š â€˜VRRP é«˜å¯ç”¨â€™ï¼šä¹Ÿå°±æ˜¯ä¸Šé¢è¯´çš„ï¼Œç®¡ç† VIP åœ¨å¤šå°æœåŠ¡å™¨ä¹‹é—´æ¼‚ç§»ã€‚ â€˜å¥åº·æ£€æŸ¥ (Health Checking)â€™ï¼š â€™ å®ƒå¯ä»¥æ£€æŸ¥åç«¯çœŸå®æœåŠ¡å™¨ï¼ˆå¦‚ Nginxã€MySQLï¼‰æ˜¯å¦æ´»ç€ã€‚ â€™ â€˜Layer 3 (IPå±‚)â€™ï¼šé€šè¿‡ ICMP (Ping) æ£€æŸ¥ã€‚ â€™ â€˜Layer 4 (TCPç«¯å£å±‚)â€™ï¼šæ£€æŸ¥ç«¯å£ï¼ˆå¦‚ 80, 3306ï¼‰æ˜¯å¦é€šã€‚ â€™ â€˜Layer 7 (åº”ç”¨å±‚)â€™ï¼šé€šè¿‡è‡ªå®šä¹‰è„šæœ¬æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼ˆæ¯”å¦‚ Nginx è¿›ç¨‹è¿˜åœ¨ï¼Œä½†ç½‘é¡µè¿”å› 500 é”™è¯¯ï¼‰ã€‚ â€˜Keepalived çš„ç»„ä»¶ç»“æ„â€™ï¼š â€™ â€˜Checkersâ€™ï¼šè´Ÿè´£çœŸå®æœåŠ¡å™¨çš„å¥åº·æ£€æŸ¥ã€‚ â€™ â€˜VRRP Stackâ€™ï¼šå¤„ç† VRRP åè®®çš„å¹¿æ’­å’Œé€‰ä¸¾ã€‚ â€™ â€˜Netlink Reflectorâ€™ï¼šä¸ Linux å†…æ ¸äº¤äº’ï¼Œè´Ÿè´£åœ¨ç½‘å¡ä¸Šæ·»åŠ æˆ–åˆ é™¤ VIPã€‚ ","date":"2025-12-23","objectID":"/whats-keepalived/:0:3","tags":["Linux","è¿ç»´","é«˜å¯ç”¨é›†ç¾¤"],"title":"keepalived","uri":"/whats-keepalived/"},{"categories":["Tech"],"content":"4. ç¼ºçœè·¯ç”± (Default Route) ä¸ Keepalived â€˜è§’åº¦ä¸€ï¼šå®¢æˆ·ç«¯/ä¸‹æ¸¸è®¾å¤‡çš„ç¼ºçœç½‘å…³â€™ â€™ â€˜åœºæ™¯â€™ï¼šKeepalived ç”¨åœ¨è·¯ç”±å™¨æˆ–é˜²ç«å¢™çš„é«˜å¯ç”¨ä¸Šã€‚ â€™ â€˜ä½œç”¨â€™ï¼šå±€åŸŸç½‘å†…çš„ç”µè„‘éœ€è¦ä¸Šç½‘ï¼Œå®ƒä»¬çš„â€™ç¼ºçœè·¯ç”±ï¼ˆç½‘å…³ï¼‰â€˜æŒ‡å‘çš„æ˜¯ VRRP ç”Ÿæˆçš„ â€˜VIPâ€™ã€‚ â€™ â€˜æ•ˆæœâ€™ï¼šå½“ä¸»è·¯ç”±å™¨æŒ‚æ‰ï¼ŒVIP æ¼‚ç§»åˆ°å¤‡ç”¨è·¯ç”±å™¨ï¼Œå±€åŸŸç½‘å†…çš„ç”µè„‘æ— æ„ŸçŸ¥ï¼Œä¾ç„¶é€šè¿‡ VIP ä¸Šç½‘ã€‚ â€˜è§’åº¦äºŒï¼šæœåŠ¡å™¨æœ¬èº«çš„è·¯ç”±â€™ â€™ â€˜åœºæ™¯â€™ï¼šKeepalived éƒ¨ç½²åœ¨æœåŠ¡å™¨ä¸Šï¼ˆå¦‚ Nginx è´Ÿè½½å‡è¡¡ï¼‰ã€‚ â€™ â€˜é—®é¢˜â€™ï¼šKeepalived é…ç½®æ–‡ä»¶ä¸­æœ‰ä¸€ä¸ª virtual_routes åŒºå—ã€‚ â€™ â€˜ä½œç”¨â€™ï¼šå½“è¿™å°æœºå™¨å˜æˆ Master æ—¶ï¼Œå¯ä»¥è‡ªåŠ¨æ·»åŠ ä¸€æ¡è·¯ç”±è§„åˆ™ï¼›å½“å®ƒå˜æˆ Backup æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤ã€‚ â€™ â€˜å®æˆ˜â€™ï¼šé€šå¸¸åœ¨æœåŠ¡å™¨æ¨¡å¼ä¸‹æˆ‘ä»¬å¾ˆå°‘é… virtual_routesï¼Œåªé… virtual_ipaddress å°±å¤Ÿäº†ã€‚ä½†åœ¨å¤æ‚çš„åŒç½‘å¡ã€è·¨ç½‘æ®µç¯å¢ƒä¸­ï¼Œå¯èƒ½éœ€è¦ç”¨å®ƒæ¥æŒ‡å®šå›åŒ…çš„è·¯ç”±ã€‚ ","date":"2025-12-23","objectID":"/whats-keepalived/:0:4","tags":["Linux","è¿ç»´","é«˜å¯ç”¨é›†ç¾¤"],"title":"keepalived","uri":"/whats-keepalived/"},{"categories":["Tech"],"content":"5. é«˜å¯ç”¨æ–¹å¼ (HA Modes) Keepalived å¸¸è§çš„æ¶æ„æ¨¡å¼ä¸»è¦æœ‰ä¸¤ç§ï¼š æ¨¡å¼ä¸€ï¼šä¸»å¤‡æ¨¡å¼ (Active-Standby) â€”â€” æœ€å¸¸ç”¨ã€æœ€ç®€å• ' 'æ¶æ„'ï¼šèŠ‚ç‚¹ A (Master) + èŠ‚ç‚¹ B (Backup)ã€‚ ' 'VIP'ï¼šåªæœ‰ 1 ä¸ª VIPã€‚ ' 'çŠ¶æ€'ï¼š ' æ­£å¸¸æ—¶ï¼šVIP åœ¨èŠ‚ç‚¹ A ä¸Šï¼Œæ‰€æœ‰æµé‡åªèµ° Aã€‚èŠ‚ç‚¹ B é—²ç½®ï¼ˆä½œä¸ºå†·å¤‡ï¼‰ã€‚ ' æ•…éšœæ—¶ï¼šVIP æ¼‚ç§»åˆ° Bï¼Œæµé‡èµ° Bã€‚ ' 'ä¼˜ç‚¹'ï¼šé…ç½®ç®€å•ï¼Œæå°‘å‡ºç°æ•°æ®ä¸ä¸€è‡´ã€‚ ' ''ç¼ºç‚¹''ï¼šæµªè´¹äº†ä¸€å°æœåŠ¡å™¨çš„èµ„æºï¼ˆèŠ‚ç‚¹ B å¹³æ—¶æ²¡äº‹å¹²ï¼‰ã€‚ æ¨¡å¼äºŒï¼šåŒä¸»æ¨¡å¼ (Active-Active) / åŒä¸»åŒå¤‡ ' ''æ¶æ„''ï¼šèŠ‚ç‚¹ A + èŠ‚ç‚¹ Bã€‚ ' ''VIP''ï¼šé…ç½® ''2 ä¸ª VIP'' (VIP1, VIP2)ã€‚ ' ''é…ç½®é€»è¾‘''ï¼š ' å¯¹äº VIP1ï¼šèŠ‚ç‚¹ A æ˜¯ Masterï¼ŒèŠ‚ç‚¹ B æ˜¯ Backupã€‚ ' å¯¹äº VIP2ï¼šèŠ‚ç‚¹ B æ˜¯ Masterï¼ŒèŠ‚ç‚¹ A æ˜¯ Backupã€‚ ' ''æµé‡åˆ†é…''ï¼šé€šè¿‡ DNS è½®è¯¢ï¼Œå°†ä¸€åŠç”¨æˆ·è§£æåˆ° VIP1ï¼Œä¸€åŠè§£æåˆ° VIP2ã€‚ ' ''çŠ¶æ€''ï¼šä¸¤å°æœºå™¨åŒæ—¶å·¥ä½œã€‚å¦‚æœ A æŒ‚äº†ï¼ŒVIP1 è·‘åˆ° B ä¸Šï¼Œæ­¤æ—¶ B æ‹¥æœ‰ä¸¤ä¸ª VIPï¼Œæ‰¿æ‹…æ‰€æœ‰æµé‡ã€‚ ' ''ä¼˜ç‚¹''ï¼šèµ„æºåˆ©ç”¨ç‡é«˜ã€‚ ","date":"2025-12-23","objectID":"/whats-keepalived/:0:5","tags":["Linux","è¿ç»´","é«˜å¯ç”¨é›†ç¾¤"],"title":"keepalived","uri":"/whats-keepalived/"},{"categories":["Tech"],"content":"6. å®æˆ˜é…ç½®ç¤ºä¾‹ (ä¸»å¤‡æ¨¡å¼) å‡è®¾æˆ‘ä»¬è¦å¯¹ä¸¤å° Nginx è´Ÿè½½å‡è¡¡å™¨åšé«˜å¯ç”¨ã€‚ â€™ Master IP: 192.168.1.10 â€™ Backup IP: 192.168.1.11 â€™ â€˜â€˜VIP: 192.168.1.100â€™â€™ A. Master èŠ‚ç‚¹é…ç½® (/etc/keepalived/keepalived.conf) global_defs { router_id LVS_DEVEL_MASTER # æ ‡è¯†æœ¬èŠ‚ç‚¹çš„IDï¼Œéšä¾¿å†™ä½†è¦å”¯ä¸€ } # å®šä¹‰ä¸€ä¸ªæ£€æµ‹è„šæœ¬ï¼Œç”¨æ¥æ£€æŸ¥ Nginx æ˜¯å¦æ´»ç€ vrrp_script check_nginx { script \"/etc/keepalived/check_nginx.sh\" interval 2 # æ¯2ç§’æ£€æµ‹ä¸€æ¬¡ weight -20 # å¦‚æœæ£€æµ‹å¤±è´¥ï¼Œæƒé‡å‡å°‘20 } vrrp_instance VI_1 { state MASTER # åˆå§‹çŠ¶æ€ï¼šMaster interface eth0 # ç»‘å®šVIPçš„ç½‘å¡ virtual_router_id 51 # VRIDï¼Œä¸»å¤‡å¿…é¡»ä¸€è‡´ï¼ priority 100 # ä¼˜å…ˆçº§ï¼ŒMasterè¦æ¯”Backupé«˜ advert_int 1 # å¹¿æ’­é—´éš”1ç§’ authentication { auth_type PASS auth_pass 1111 # å¯†ç ï¼Œä¸»å¤‡å¿…é¡»ä¸€è‡´ } virtual_ipaddress { 192.168.1.100 #è¿™å°±æ˜¯ VIP } track_script { check_nginx # è°ƒç”¨ä¸Šé¢çš„æ£€æµ‹è„šæœ¬ } } B. Backup èŠ‚ç‚¹é…ç½® global_defs { router_id LVS_DEVEL_BACKUP } vrrp_script check_nginx { script \"/etc/keepalived/check_nginx.sh\" interval 2 weight -20 } vrrp_instance VI_1 { state BACKUP # åˆå§‹çŠ¶æ€ï¼šBackup interface eth0 virtual_router_id 51 # å¿…é¡»å’ŒMasterä¸€æ · priority 90 # ä¼˜å…ˆçº§å¿…é¡»æ¯”Masterä½ advert_int 1 authentication { auth_type PASS auth_pass 1111 } virtual_ipaddress { 192.168.1.100 } track_script { check_nginx } } C. å…³é”®ç‚¹ï¼šå¥åº·æ£€æµ‹è„šæœ¬ Keepalived è¿›ç¨‹æ´»ç€ä¸ä»£è¡¨ä¸šåŠ¡æ´»ç€ã€‚å¦‚æœ Nginx æŒ‚äº†ï¼ŒKeepalived è¿˜åœ¨ï¼ŒVIP å°±ä¸ä¼šæ¼‚ç§»ï¼Œç”¨æˆ·è®¿é—®å°±ä¼šæŠ¥é”™ã€‚æ‰€ä»¥å¿…é¡»é…åˆè„šæœ¬ï¼š è„šæœ¬é€»è¾‘ï¼šâ€˜å¦‚æœ Nginx è¿›ç¨‹ä¸å­˜åœ¨ï¼Œå°±å°è¯•é‡å¯ Nginxï¼›å¦‚æœè¿˜ä¸è¡Œï¼Œå°±æ€æ‰ Keepalived è¿›ç¨‹ï¼ˆæˆ–è€…é™ä½æƒé‡ï¼‰ï¼Œè§¦å‘ VIP æ¼‚ç§»ã€‚â€™ ","date":"2025-12-23","objectID":"/whats-keepalived/:0:6","tags":["Linux","è¿ç»´","é«˜å¯ç”¨é›†ç¾¤"],"title":"keepalived","uri":"/whats-keepalived/"},{"categories":["Tech"],"content":"7. å¸¸è§é—®é¢˜ï¼šè„‘è£‚ (Split Brain) â€˜â€˜ä»€ä¹ˆæ˜¯è„‘è£‚ï¼Ÿâ€™â€™ ä¸»å¤‡ä¹‹é—´çš„å¿ƒè·³çº¿æ–­äº†ï¼ˆæ¯”å¦‚é˜²ç«å¢™æŒ¡ä½äº† VRRP ç»„æ’­åŒ…ï¼Œæˆ–è€…ç½‘çº¿æ–­äº†ï¼‰ï¼ŒBackup ä»¥ä¸º Master æ­»äº†ï¼Œäºæ˜¯å¼ºè¡Œæ¥ç®¡ VIPã€‚ç»“æœæ˜¯ï¼šâ€˜â€˜Master å’Œ Backup éƒ½æœ‰ VIPâ€™â€™ã€‚ â€˜â€˜åæœâ€™â€™ï¼š IP å†²çªï¼Œæ•°æ®å†™å…¥æ··ä¹±ï¼Œç”¨æˆ·è®¿é—®æ—¶é€šæ—¶æ–­ã€‚ â€˜â€˜å¦‚ä½•é¢„é˜²ï¼Ÿâ€™â€™ é˜²ç«å¢™å…è®¸ VRRP åè®®ï¼ˆIP åè®®å· 112ï¼‰é€šè¿‡ã€‚ ä½¿ç”¨ä¸²è¡Œç”µç¼†æˆ–å¤šæ¡çº¿è·¯åšå¿ƒè·³å†—ä½™ã€‚ è„šæœ¬æ£€æµ‹ï¼šä¸€æ—¦å‘ç°è‡ªå·±æ˜¯ Master ä½† Ping ä¸é€šç½‘å…³ï¼Œè‡ªåŠ¨é™çº§ã€‚ ","date":"2025-12-23","objectID":"/whats-keepalived/:0:7","tags":["Linux","è¿ç»´","é«˜å¯ç”¨é›†ç¾¤"],"title":"keepalived","uri":"/whats-keepalived/"},{"categories":["Tech"],"content":"æ€»ç»“ ' ''Keepalived'' = ''VRRP'' (æŠ¢ VIP) + ''Health Check'' (çœ‹ç—…)ã€‚ ' ''VRRP'' è®©å¤šå°æœºå™¨å…±äº«ä¸€ä¸ª ''VIP''ï¼Œè°ä¼˜å…ˆçº§é«˜è°æ‹¿ã€‚ ' ''ç¼ºçœè·¯ç”±'' åœ¨è¿™é‡Œé€šå¸¸æŒ‡å®¢æˆ·ç«¯å°† VIP ä½œä¸ºç½‘å…³ï¼Œæˆ–è€… Keepalived è‡ªèº«ç®¡ç†è·¯ç”±è¡¨ã€‚ ' æœ€ç¨³çš„æ¶æ„æ˜¯ ''ä¸»å¤‡æ¨¡å¼ (Master/Backup)''ã€‚ ' ä¸€å®šè¦é…ç½® 'å¥åº·æ£€æµ‹è„šæœ¬'ï¼Œç¡®ä¿åº”ç”¨æŒ‚äº† VIP èƒ½åŠæ—¶åˆ‡æ¢ã€‚ ","date":"2025-12-23","objectID":"/whats-keepalived/:0:8","tags":["Linux","è¿ç»´","é«˜å¯ç”¨é›†ç¾¤"],"title":"keepalived","uri":"/whats-keepalived/"},{"categories":["Tech","DevOps","Linux","High Availability"],"content":"Building a Keepalived + Nginx Dual-Master HA Cluster from Scratch (Ubuntu 24.04) Preface: I recently grabbed a domain for just a dollar and decided to tinker with server high availability architectures. In a production environment, a single point of failure (SPOF) is a DevOps nightmare. Today, Iâ€™m documenting how I used Keepalived to implement a Dual-Master (Active-Active) architecture. Goal: Two servers acting as backups for each other. Normally, each handles one VIP (Virtual IP). If one server fails, the other instantly takes over all traffic! ","date":"2025-12-23","objectID":"/building-keepalived-nginx-dual-master-ha-cluster/:0:0","tags":["nginx","keepalived","ubuntu","load-balancing"],"title":"Building a Keepalived + Nginx Dual-Master HA Cluster from Scratch (Ubuntu 24.04)","uri":"/building-keepalived-nginx-dual-master-ha-cluster/"},{"categories":["Tech","DevOps","Linux","High Availability"],"content":"ğŸ› ï¸ Environment Preparation Role Hostname IP Address Interface Initial Task Node A ubuntu-13 10.0.0.13 ens33 Master (VIP1) / Backup (VIP2) Node B ubuntu-16 10.0.0.16 eth0 Backup (VIP1) / Master (VIP2) VIP 1 - 10.0.0.100 - Primary Entry Point VIP 2 - 10.0.0.200 - Secondary/Load Balancing Entry Point Note: My two machines have different network interface names (ens33 vs eth0). This caused some issues during configuration, so please verify your own interface names using ip addr before proceeding! ","date":"2025-12-23","objectID":"/building-keepalived-nginx-dual-master-ha-cluster/:1:0","tags":["nginx","keepalived","ubuntu","load-balancing"],"title":"Building a Keepalived + Nginx Dual-Master HA Cluster from Scratch (Ubuntu 24.04)","uri":"/building-keepalived-nginx-dual-master-ha-cluster/"},{"categories":["Tech","DevOps","Linux","High Availability"],"content":"1. Installing Software Execute the following commands on both machines: sudo apt update sudo apt install -y keepalived nginx net-tools To easily verify the failover effect, letâ€™s modify the default Nginx index page to display different content on each node: On Node A (10.0.0.13): echo \"\u003ch1\u003eI am Node A (13)\u003c/h1\u003e\" | sudo tee /var/www/html/index.nginx-debian.html On Node B (10.0.0.16): echo \"\u003ch1\u003eI am Node B (16)\u003c/h1\u003e\" | sudo tee /var/www/html/index.nginx-debian.html ","date":"2025-12-23","objectID":"/building-keepalived-nginx-dual-master-ha-cluster/:2:0","tags":["nginx","keepalived","ubuntu","load-balancing"],"title":"Building a Keepalived + Nginx Dual-Master HA Cluster from Scratch (Ubuntu 24.04)","uri":"/building-keepalived-nginx-dual-master-ha-cluster/"},{"categories":["Tech","DevOps","Linux","High Availability"],"content":"2. Configuring Health Check Script Keepalived needs a script to determine if the service is down. Weâ€™ll create a simple script that checks for the existence of a specific file to simulate a failure (this can later be changed to check for the Nginx process). Perform this on both machines: # Create the directory for scripts sudo mkdir -p /etc/keepalived/scripts # Create the script file sudo nano /etc/keepalived/scripts/check_fail.sh Script Content: #!/bin/bash # If the file /tmp/keepalived.fail exists, return 1 (failure), triggering a priority downgrade. if [ -f \"/tmp/keepalived.fail\" ]; then exit 1 else exit 0 fi Grant execution permissions (Crucial!): sudo chmod +x /etc/keepalived/scripts/check_fail.sh ","date":"2025-12-23","objectID":"/building-keepalived-nginx-dual-master-ha-cluster/:3:0","tags":["nginx","keepalived","ubuntu","load-balancing"],"title":"Building a Keepalived + Nginx Dual-Master HA Cluster from Scratch (Ubuntu 24.04)","uri":"/building-keepalived-nginx-dual-master-ha-cluster/"},{"categories":["Tech","DevOps","Linux","High Availability"],"content":"3. Core Configuration: Active-Active Setup This is the most critical part. We use the VRRP protocol to let the two machines monitor each other. ","date":"2025-12-23","objectID":"/building-keepalived-nginx-dual-master-ha-cluster/:4:0","tags":["nginx","keepalived","ubuntu","load-balancing"],"title":"Building a Keepalived + Nginx Dual-Master HA Cluster from Scratch (Ubuntu 24.04)","uri":"/building-keepalived-nginx-dual-master-ha-cluster/"},{"categories":["Tech","DevOps","Linux","High Availability"],"content":"ğŸ“„ Node A (192.168.8.13) Configuration Edit /etc/keepalived/keepalived.conf: global_defs { router_id NODE_A script_user root enable_script_security } # Define the health check script vrrp_script chk_manual { script \"/etc/keepalived/scripts/check_fail.sh\" interval 2 weight -30 } # Instance 1: I am MASTER, claiming VIP 100 vrrp_instance VI_1 { state MASTER interface ens33 # âš ï¸ Note: Use your actual interface name virtual_router_id 50 # ID must match on both sides priority 100 # Higher score = Master advert_int 1 unicast_src_ip 10.0.0.13 unicast_peer { 10.0.0.16 } authentication { auth_type PASS auth_pass 1111 } virtual_ipaddress { 10.0.0.100 dev ens33 label ens33:1 } track_script { chk_manual } } # Instance 2: I am BACKUP, standby for VIP 200 vrrp_instance VI_2 { state BACKUP interface ens33 virtual_router_id 60 # ID must be unique and match on both sides priority 90 # Lower score = Backup advert_int 1 unicast_src_ip 192.168.8.13 unicast_peer { 192.168.8.16 } authentication { auth_type PASS auth_pass 2222 } virtual_ipaddress { 10.0.0.200 dev ens33 label ens33:2 } track_script { chk_manual } } ","date":"2025-12-23","objectID":"/building-keepalived-nginx-dual-master-ha-cluster/:4:1","tags":["nginx","keepalived","ubuntu","load-balancing"],"title":"Building a Keepalived + Nginx Dual-Master HA Cluster from Scratch (Ubuntu 24.04)","uri":"/building-keepalived-nginx-dual-master-ha-cluster/"},{"categories":["Tech","DevOps","Linux","High Availability"],"content":"ğŸ“„ Node B (192.168.8.16) Configuration Edit /etc/keepalived/keepalived.conf: global_defs { router_id NODE_B script_user root enable_script_security } vrrp_script chk_manual { script \"/etc/keepalived/scripts/check_fail.sh\" interval 2 weight -30 } # Instance 1: I am BACKUP, standby for VIP 100 vrrp_instance VI_1 { state BACKUP interface eth0 # âš ï¸ Note: This machine uses eth0 virtual_router_id 50 priority 90 # Lower score = Backup advert_int 1 unicast_src_ip 10.0.0.16 unicast_peer { 10.0.0.13 } authentication { auth_type PASS auth_pass 1111 } virtual_ipaddress { 10.0.0.100 dev eth0 label eth0:1 } track_script { chk_manual } } # Instance 2: I am MASTER, claiming VIP 200 vrrp_instance VI_2 { state MASTER interface eth0 virtual_router_id 60 priority 100 # Higher score = Master advert_int 1 unicast_src_ip 10.0.0.16 unicast_peer { 10.0.0.13 } authentication { auth_type PASS auth_pass 2222 } virtual_ipaddress { 10.0.0.200 dev eth0 label eth0:2 } track_script { chk_manual } } ","date":"2025-12-23","objectID":"/building-keepalived-nginx-dual-master-ha-cluster/:4:2","tags":["nginx","keepalived","ubuntu","load-balancing"],"title":"Building a Keepalived + Nginx Dual-Master HA Cluster from Scratch (Ubuntu 24.04)","uri":"/building-keepalived-nginx-dual-master-ha-cluster/"},{"categories":["Tech","DevOps","Linux","High Availability"],"content":"4. Start and Verify ","date":"2025-12-23","objectID":"/building-keepalived-nginx-dual-master-ha-cluster/:5:0","tags":["nginx","keepalived","ubuntu","load-balancing"],"title":"Building a Keepalived + Nginx Dual-Master HA Cluster from Scratch (Ubuntu 24.04)","uri":"/building-keepalived-nginx-dual-master-ha-cluster/"},{"categories":["Tech","DevOps","Linux","High Availability"],"content":"Start the Service sudo systemctl restart keepalived ","date":"2025-12-23","objectID":"/building-keepalived-nginx-dual-master-ha-cluster/:5:1","tags":["nginx","keepalived","ubuntu","load-balancing"],"title":"Building a Keepalived + Nginx Dual-Master HA Cluster from Scratch (Ubuntu 24.04)","uri":"/building-keepalived-nginx-dual-master-ha-cluster/"},{"categories":["Tech","DevOps","Linux","High Availability"],"content":"Check Status Under normal conditions: Node A holds VIP 10.0.0.100. Node B holds VIP 10.0.0.200. Both machines are active, utilizing resources efficiently! ","date":"2025-12-23","objectID":"/building-keepalived-nginx-dual-master-ha-cluster/:5:2","tags":["nginx","keepalived","ubuntu","load-balancing"],"title":"Building a Keepalived + Nginx Dual-Master HA Cluster from Scratch (Ubuntu 24.04)","uri":"/building-keepalived-nginx-dual-master-ha-cluster/"},{"categories":["Tech","DevOps","Linux","High Availability"],"content":"ğŸ’£ Simulating a Hard Crash I tried stopping the Keepalived service on Node A to simulate a server crash: # Execute on Node A systemctl stop keepalived The Miracle Happens: Checking the IP on Node B (ip addr), I found it instantly grabbed VIP 100 as well! At this moment, Node B holds both VIPs (100 and 200), handling all traffic alone. When I restarted Node A, VIP 100 automatically floated back, restoring the Active-Active state. ","date":"2025-12-23","objectID":"/building-keepalived-nginx-dual-master-ha-cluster/:5:3","tags":["nginx","keepalived","ubuntu","load-balancing"],"title":"Building a Keepalived + Nginx Dual-Master HA Cluster from Scratch (Ubuntu 24.04)","uri":"/building-keepalived-nginx-dual-master-ha-cluster/"},{"categories":["Tech","DevOps","Linux","High Availability"],"content":"ğŸ“ Lessons Learned \u0026 Tips Network Interface Names: Always check with ip addr. Different machines might have different interface names (e.g., ens33 vs eth0), and putting the wrong one in the config causes immediate failure. Unicast Mode: In cloud environments or specific networks, Multicast might be blocked. It is recommended to configure unicast_peer to use Unicast. Syntax Sensitivity: The Keepalived configuration file is very sensitive to brackets {} and spaces. Be careful when copy-pasting. Troubleshooting: When in doubt, journalctl -u keepalived -f is your best friend for debugging. Keepalived combined with Nginx is a classic open-source High Availability solution. The configuration is simple, but it is incredibly stable! If you have some spare servers, give it a try! (Originally published on 1water1.top) ","date":"2025-12-23","objectID":"/building-keepalived-nginx-dual-master-ha-cluster/:6:0","tags":["nginx","keepalived","ubuntu","load-balancing"],"title":"Building a Keepalived + Nginx Dual-Master HA Cluster from Scratch (Ubuntu 24.04)","uri":"/building-keepalived-nginx-dual-master-ha-cluster/"},{"categories":null,"content":"ğŸ¤– æœºå™¨äººè‡ªåŠ¨æ’­æŠ¥ åŒ—äº¬æ—¶é—´ï¼š2025-12-18 09:38:14 ä»Šæ—¥å¤©æ°”ï¼š Beijing: ğŸŒ« -1Â°C (æœ¬æ–‡ç« ç”± GitHub Actions è‡ªåŠ¨æŠ“å–å¹¶å‘å¸ƒ) ","date":"2025-12-18","objectID":"/weather-2025-12-18/:1:0","tags":["è‡ªåŠ¨æ’­æŠ¥","å¤©æ°”"],"title":"ğŸ“… 2025-12-18 æ¯æ—¥å¤©æ°”æ’­æŠ¥","uri":"/weather-2025-12-18/"}]